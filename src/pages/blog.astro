---
import Layout from '../layouts/Layout.astro';
import { getDatabaseContents, getDatabaseMetadata, mapPageProperties } from "../lib/notion";
import type { NotionPage } from "../types/notion";
import NotionGallery from "../components/Glaze/NotionGallery.astro";
import config from "../../site.config.mjs";

// 0. 데이터베이스 메타데이터 및 태그 목록 추출
const database = await getDatabaseMetadata();
const dbTitle = database?.title?.[0]?.plain_text || config.site.archiveTitle;
const tags = database?.properties?.[config.notion.propertyMap.tags]?.multi_select?.options?.map((opt: any) => opt.name) || [];

// 1. 게시글 데이터 가져오기
const allPagesRaw = await getDatabaseContents();
const posts = allPagesRaw
  .map(mapPageProperties)
  .filter((p: NotionPage) => p.slug && p.slug !== 'home'); // home 페이지는 목록에서 제외
---

<Layout title={dbTitle}>
  <main class="max-w-6xl mx-auto px-6 py-12 md:py-20">
    
    <div class="text-center mb-20 space-y-4">
      <h1 class="text-5xl md:text-7xl font-black text-slate-900 tracking-tight">
        {config.site.archiveTitle.split(' ')[0]}
        <span class="text-primary">{config.site.archiveTitle.split(' ')[1]}</span>
      </h1>
      <p class="text-xl text-slate-500 max-w-2xl mx-auto font-medium">
        {database.description?.[0]?.plain_text || config.site.description}
      </p>

      {/* 태그 필터 (UI 준비) */}
      {tags.length > 0 && (
        <div class="flex flex-wrap justify-center gap-2 mt-8">
          <button class="px-4 py-2 rounded-full bg-primary text-white text-sm font-bold">All</button>
          {tags.map((tag: string) => (
            <button class="px-4 py-2 rounded-full bg-slate-100 text-slate-600 text-sm font-medium hover:bg-slate-200 transition-colors">
              {tag}
            </button>
          ))}
        </div>
      )}
    </div>

    <NotionGallery posts={posts} />

  </main>
</Layout>
