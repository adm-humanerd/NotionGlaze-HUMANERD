---
import Layout from '../../layouts/Layout.astro';
import NotionRenderer from '../../components/Glaze/NotionRenderer.astro';
import { getBlocks, getDatabaseContents, mapPageProperties } from "../../lib/notion";
import { slugify } from "../../utils/slugify";
import type { NotionPage, NotionBlock } from "../../types/notion";

// 1. URL 파라미터에서 slug 추출
const { slug } = Astro.params;

// 2. 전체 글 목록 가져오기 (현재 글 찾기 + 관련 글 추천용)
// Notion API 특성상 리스트를 가져와서 찾는 방식이 효율적일 수 있습니다.
const allPagesRaw = await getDatabaseContents();
const allPosts = allPagesRaw.map(mapPageProperties);

// 3. 현재 slug에 해당하는 글 찾기
const post = allPosts.find((p) => p.slug === slug);

// 글이 없으면 404 페이지로 리다이렉트
if (!post) {
  return Astro.redirect('/404');
}

// 4. 본문 데이터(Blocks) 조회
const blocks: NotionBlock[] = await getBlocks(post.id);

// 5. 목차(TOC) 데이터 추출
const headings = blocks
  .filter((block: NotionBlock) => 
    block.type === 'heading_1' || 
    block.type === 'heading_2' || 
    block.type === 'heading_3'
  )
  .map((block: NotionBlock) => {
    const blockData = (block as any)[block.type];
    const richText = blockData.rich_text || blockData.text || [];
    const text = richText.map((t: any) => t.plain_text).join('') || "";
    return { text, slug: slugify(text), type: block.type };
  });

// 6. 관련 글 필터링 (이미 위에서 allPosts를 가져왔으므로 재사용)
const relatedPosts = allPosts
  .filter((p: NotionPage) => p.id !== post.id && p.slug !== 'home' && p.tags?.some((t: string) => post.tags?.includes(t)))
  .slice(0, 3);
---

<Layout title={post.title}>
  <div class="max-w-7xl mx-auto px-6 py-12 grid grid-cols-1 lg:grid-cols-12 gap-12">
    
    {/* 본문 영역 */}
    <article class="lg:col-span-8 max-w-none">
      {post.cover && (
        <div class="w-full h-64 md:h-96 rounded-3xl overflow-hidden mb-12 shadow-sm border border-slate-100 dark:border-slate-800">
          <img 
            src={post.cover} 
            alt={post.title} 
            class="w-full h-full object-cover"
          />
        </div>
      )}

      <header class="mb-12">
        <div class="flex items-center gap-2 mb-4">
            <span class="text-primary font-bold text-xs uppercase bg-pink-50 dark:bg-pink-950/30 px-3 py-1 rounded-full">Blog Post</span>
            <span class="text-slate-400 text-xs">{new Date(post.publishedAt).toLocaleDateString()}</span>
        </div>
        <h1 class="text-3xl md:text-5xl font-black text-slate-900 dark:text-white leading-tight mb-6">
          {post.title}
        </h1>
        {post.tags && post.tags.length > 0 && (
            <div class="flex flex-wrap gap-2">
                {post.tags.map((tag: string) => (
                    <span class="text-sm text-slate-500 bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded hover:bg-slate-200 transition-colors">#{tag}</span>
                ))}
            </div>
        )}
      </header>
      
      {/* 렌더러 호출 */}
      <div class="notion-renderer max-w-3xl">
        <NotionRenderer blocks={blocks} />
     </div>
    </article>

    {/* 사이드바 (목차) */}
    <aside class="hidden lg:block lg:col-span-4 space-y-8">
      <div class="sticky top-28">
        
        {headings.length > 0 && (
          <div class="bg-white dark:bg-slate-900/50 p-6 rounded-2xl border border-slate-100 dark:border-slate-800 shadow-sm mb-8">
            <h3 class="font-bold text-slate-900 dark:text-white mb-4 border-b dark:border-slate-800 pb-3 text-sm tracking-wide">ON THIS PAGE</h3>
            <ul class="space-y-2">
              {headings.map((h: any) => (
                <li>
                  <a 
                    href={`#${h.slug}`} 
                    class={`block transition-colors duration-200 leading-snug py-1
                      ${h.type === 'heading_1' 
                        ? 'text-slate-900 dark:text-slate-100 font-bold text-sm hover:text-primary' 
                        : h.type === 'heading_2' 
                          ? 'text-slate-600 dark:text-slate-400 font-medium text-xs pl-3 border-l-2 border-transparent hover:border-primary hover:text-primary' 
                          : 'text-slate-400 dark:text-slate-500 text-[11px] pl-5 hover:text-slate-600' 
                      }
                    `}
                  >
                    {h.text}
                  </a>
                </li>
              ))}
            </ul>
          </div>
        )}

        {/* 관련 글 */}
        {relatedPosts.length > 0 && (
            <div class="bg-slate-50 dark:bg-slate-900/30 p-6 rounded-2xl border border-slate-100 dark:border-slate-800 shadow-sm">
                <h3 class="font-bold text-slate-900 dark:text-white mb-4 text-sm uppercase tracking-wide">관련 글</h3>
                <ul class="space-y-4">
                    {relatedPosts.map((p: NotionPage) => (
                        <li>
                            <a href={`/post/${p.slug}`} class="group block">
                                <h4 class="text-sm font-bold text-slate-700 dark:text-slate-300 group-hover:text-primary transition-colors line-clamp-2">{p.title}</h4>
                                <span class="text-xs text-slate-400">{new Date(p.publishedAt).toLocaleDateString()}</span>
                            </a>
                        </li>
                    ))}
                </ul>
            </div>
        )}

      </div>
    </aside>

  </div>
</Layout>
