---
import { slugify } from "../../utils/slugify";
import RecursiveBlock from './NotionRenderer.astro';
import NotionGallery from './NotionGallery.astro';

interface Props {
  blocks: any[];
}

const { blocks } = Astro.props;

// --- í—¬í¼ í•¨ìˆ˜ë“¤ ---

// ğŸ¨ [ìƒ‰ìƒ ë³€í™˜ê¸°] Notion ìƒ‰ìƒ -> Tailwind CSS í´ë˜ìŠ¤
const colorMap: Record<string, { text: string; bg: string }> = {
  default: { text: "text-slate-800", bg: "bg-white" },
  gray:    { text: "text-slate-600", bg: "bg-slate-100" },
  brown:   { text: "text-amber-800", bg: "bg-amber-100" },
  orange:  { text: "text-orange-700", bg: "bg-orange-100" },
  yellow:  { text: "text-yellow-700", bg: "bg-yellow-100" },
  green:   { text: "text-emerald-700", bg: "bg-emerald-100" },
  blue:    { text: "text-blue-700",   bg: "bg-blue-100" },
  purple:  { text: "text-purple-700", bg: "bg-purple-100" },
  pink:    { text: "text-pink-700",   bg: "bg-pink-100" },
  red:     { text: "text-red-700",    bg: "bg-red-100" },
};

const getColorClass = (colorName: string, type: 'text' | 'bg' = 'text'): string => {
  if (!colorName || colorName === 'default') return "";
  const baseColor = colorName.replace('_background', '');
  const color = colorMap[baseColor];
  if (!color) return "";
  return type === 'bg' || colorName.endsWith('_background') ? color.bg : color.text;
};

// âœï¸ [Rich Text ë Œë”ëŸ¬] ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ ì ìš©
const renderRichText = (richTextArray: any[]): string => {
  if (!Array.isArray(richTextArray)) return "";
  return richTextArray.map((t) => {
    const content = t.plain_text || t.text?.content || "";
    let styled = content;
    const anno = t.annotations || {};

    if (anno.bold) styled = `<strong>${styled}</strong>`;
    if (anno.italic) styled = `<em>${styled}</em>`;
    if (anno.strikethrough) styled = `<del>${styled}</del>`;
    if (anno.code) styled = `<code class="bg-slate-100 text-slate-600 px-1 rounded font-mono text-sm border border-slate-200">${styled}</code>`;
    
    if (anno.color && anno.color !== 'default') {
      const isBg = anno.color.endsWith('_background');
      const colorClass = getColorClass(anno.color);
      const extraClass = isBg ? 'px-1 rounded' : '';
      styled = `<span class="${colorClass} ${extraClass}">${styled}</span>`;
    }
    
    if (t.href) styled = `<a href="${t.href}" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline transition-colors">${styled}</a>`;
    
    return styled;
  }).join('');
};

// ë¸”ë¡ì—ì„œ ë Œë”ë§ ê°€ëŠ¥í•œ HTML ì½˜í…ì¸  ì¶”ì¶œ
const getHtmlContent = (block: any): string => {
    if (!block) return "";
    const type = block.type;
    const value = block[type];
    if (!value) return "";
    const richText = value.rich_text || value.text;
    return renderRichText(richText);
};

// ë¸”ë¡ ë ˆë²¨ ë°°ê²½ìƒ‰ì„ ìœ„í•œ ë˜í¼ divì˜ ì†ì„± ê°€ì ¸ì˜¤ê¸°
const getWrapperProps = (block: any) => {
  const value = block[block.type] || {};
  const color = value.color || "";
  if (color.endsWith("_background")) {
    const bgClass = getColorClass(color, 'bg');
    return { class: `p-4 rounded-lg my-2 ${bgClass}` };
  }
  return null;
};

// ğŸ”„ [ì „ì²˜ë¦¬ê¸°] ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ê·¸ë£¹í™”
const processBlocks = (rawBlocks: any[]) => {
  if (!rawBlocks || !Array.isArray(rawBlocks)) return [];
  const processed = [];
  let listGroup: any = null;

  for (const block of rawBlocks) {
    const isNum = block.type === 'numbered_list_item';
    const isBul = block.type === 'bulleted_list_item';

    if (isNum || isBul) {
      const groupType = isNum ? 'numbered_list_group' : 'bulleted_list_group';
      const itemColor = block[block.type]?.color || 'default';
      if (!listGroup || listGroup.type !== groupType || listGroup.color !== itemColor) {
         if (listGroup) processed.push(listGroup);
        listGroup = { type: groupType, items: [], color: itemColor };
      }
      listGroup.items.push(block);
    } else {
      if (listGroup) { processed.push(listGroup); listGroup = null; }
      processed.push(block);
    }
  }
  if (listGroup) processed.push(listGroup);
  return processed;
};

const modifiedBlocks = processBlocks(blocks);

/**
 * âœ¨ ë©”ì¸ ë¸”ë¡ ì½˜í…ì¸  ë Œë”ë§ í•¨ìˆ˜
 * (Wrapper divë¥¼ ì ìš©í•˜ëŠ” ë¡œì§ ë°”ê¹¥ìœ¼ë¡œ ë¶„ë¦¬)
 */
const renderBlockContent = (block: any) => {
  const type = block.type;
  const value = block[type] || {};
  const htmlContent = getHtmlContent(block);
  const children = value.children || [];

  switch (type) {
    case 'paragraph':
      if (!htmlContent) return <div class="h-4"></div>;
      const pColorClass = value.color && !value.color.endsWith('_background') ? getColorClass(value.color, 'text') : 'text-slate-700';
      return <p class:list={[`mb-2 text-base md:text-lg leading-relaxed break-words`, pColorClass]} set:html={htmlContent}></p>;

    case 'heading_1':
      return <h2 id={slugify(htmlContent.replace(/<[^>]*>/g, ''))} class="scroll-mt-24 text-3xl md:text-4xl font-black mt-12 mb-6 text-slate-900" set:html={htmlContent}></h2>;
    
    case 'heading_2':
      return <h3 id={slugify(htmlContent.replace(/<[^>]*>/g, ''))} class="scroll-mt-24 text-2xl md:text-3xl font-bold mt-10 mb-4 text-slate-800" set:html={htmlContent}></h3>;
    
    case 'heading_3':
      return <h4 id={slugify(htmlContent.replace(/<[^>]*>/g, ''))} class="scroll-mt-24 text-xl md:text-2xl font-bold mt-8 mb-3 text-slate-800" set:html={htmlContent}></h4>;

    case 'divider':
      return <hr class="my-8 border-t-2 border-slate-100" />;

    case 'quote':
      const qColorClass = value.color && !value.color.endsWith('_background') ? getColorClass(value.color, 'text') : 'text-slate-600';
      return <blockquote class:list={["border-l-4 border-primary pl-5 py-3 my-8 bg-slate-50 rounded-r-lg italic text-lg", qColorClass]} set:html={htmlContent}></blockquote>;

    case 'callout':
      const icon = value.icon?.emoji || null;
      const calloutBgColor = value.color || 'gray_background';
      const bgClass = getColorClass(calloutBgColor, 'bg');
      return (
        <div class:list={[`flex items-start p-5 my-6 rounded-xl border shadow-sm`, bgClass, bgClass.replace('bg-', 'border-')]} >
          {icon && <span class="text-2xl mr-4 select-none">{icon}</span>}
          <div class="flex-1 min-w-0">
            {htmlContent && <div class="text-slate-800 font-medium leading-relaxed" set:html={htmlContent}></div>}
            {children?.length > 0 && (
              <div class="space-y-2 text-slate-700 mt-2">
                <RecursiveBlock blocks={children} />
              </div>
            )}
          </div>
        </div>
      );

    case 'column_list':
      return <div class="flex flex-col md:flex-row gap-6 my-8 w-full items-start"><RecursiveBlock blocks={children} /></div>;

    case 'column':
      return <div class="flex-1 w-full md:w-auto min-w-0 space-y-4"><RecursiveBlock blocks={children} /></div>;

    case 'image':
      const imgUrl = value.file?.url || value.external?.url;
      if (!imgUrl) return null;
      const caption = renderRichText(value.caption);
      return (
        <figure class="my-10">
          <div class="rounded-2xl overflow-hidden border border-slate-100 shadow-sm">
            <img src={imgUrl} alt={caption.replace(/<[^>]*>/g, '') || 'Image'} class="w-full h-auto" loading="lazy" />
          </div>
          {caption && <figcaption class="text-center text-sm text-slate-500 mt-3" set:html={caption}></figcaption>}
        </figure>
      );
      
    case 'child_database':
      return <NotionGallery id={block.id} title={value.title || "Gallery"} />;

    default:
      return null;
  }
}
---

{modifiedBlocks.map((block: any) => {
  const type = block.type;

  // ë¦¬ìŠ¤íŠ¸ ê·¸ë£¹ì€ ìì²´ì ìœ¼ë¡œ ë˜í¼ ë¡œì§ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
  if (type === 'numbered_list_group' || type === 'bulleted_list_group') {
    const listColor = block.color;
    let listWrapperClass = "space-y-1 my-4";
    if(listColor && listColor.endsWith("_background")) {
        listWrapperClass = `p-4 rounded-lg my-2 ${getColorClass(listColor, 'bg')}`;
    }
    const textColorClass = listColor && !listColor.endsWith('_background') ? getColorClass(listColor, 'text') : 'text-slate-700';

    return (
      <div class={listWrapperClass}>
        {type === 'numbered_list_group' ? (
          <ol class:list={[`list-decimal list-outside ml-5`, textColorClass]}>
            {block.items.map((item: any) => (
              <li class="pl-2 leading-relaxed" set:html={getHtmlContent(item)}></li>
            ))}
          </ol>
        ) : (
          <ul class:list={[`list-disc list-outside ml-5`, textColorClass]}>
            {block.items.map((item: any) => (
              <li class="pl-2 leading-relaxed" set:html={getHtmlContent(item)}></li>
            ))}
          </ul>
        )}
      </div>
    );
  }

  // ë‹¤ë¥¸ ëª¨ë“  ë¸”ë¡ ìœ í˜•ì— ëŒ€í•´ ë˜í¼ ì ìš© ì—¬ë¶€ë¥¼ ê²°ì •í•©ë‹ˆë‹¤.
  const wrapperProps = getWrapperProps(block);

  if (wrapperProps) {
    return <div {...wrapperProps}>{renderBlockContent(block)}</div>;
  } else {
    return renderBlockContent(block);
  }
})}